name: PR Test & Coverage

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Run tests with coverage
        run: |
          python -m coverage run -m unittest discover -v
          python -m coverage json -o coverage.json

      - name: Post coverage to PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python - <<'PY'
          import json, os, urllib.request

          with open('coverage.json') as f:
              data = json.load(f)

          pct = data.get('totals', {}).get('percent', None)
          if pct is None:
              body = 'カバレッジ情報を取得できませんでした。'
          else:
              body = f'Unit test coverage: {pct:.2f}%'

          # Post comment to the PR (issues API)
          token = os.environ['GITHUB_TOKEN']
          pr = os.environ['PR_NUMBER']
          repo = os.environ['REPO']
          url = f'https://api.github.com/repos/{repo}/issues/{pr}/comments'
          data = json.dumps({'body': body}).encode()
          req = urllib.request.Request(url, data=data, headers={
              'Authorization': f'token {token}',
              'Content-Type': 'application/json',
              'User-Agent': 'coverage-bot'
          })
          with urllib.request.urlopen(req) as resp:
              print('Posted comment, status', resp.status)
          PY
